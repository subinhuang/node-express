{"version":3,"sources":["../src/route.api.js"],"names":["auth","router","Router","get","req","res","next","send","find","err","posts","json","postsList","post","body","title","content","authorId","locals","currentUser","_id","save","doc","patch","params","id","findOneAndUpdate","end","findOne","delete","remove","data","name","pass","rePass","Error","user","hashSync","isOk","compareSync","token","encode","isAdmin","admin","exp","add","valueOf","jwtSecret","opts","path","maxAge","signed","httpOnly","cookie","cookieName"],"mappings":"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","file":"route.api.js","sourcesContent":["import express from 'express';\nimport PostModel from './models/post';\nimport bcrypt from 'bcrypt';\nimport UserModel from './models/user';\nimport config from './config';\nimport * as auth  from './middlewares/auth';\nimport jwt from 'jwt-simple';\nimport moment from 'moment';\n\nconst router = express.Router();\n\n/* GET users lists. */\nrouter.get('/users', function(req, res, next) {\n  res.send('respond with a resource');\n});\n\n/* GET posts lists */\nrouter.get('/posts', function(req, res, next) {\n  PostModel.find({}, {}, function(err, posts) {\n    if (err) {\n      // err.status = 500;\n      next(err);\n    } else {\n      res.json({postsList: posts });\n    }\n  });\n});\n\n/* POST create posts */\nrouter.post('/posts/', function(req, res, next) {\n  // var title = req.body.title;\n  // var content = req.body.content;\n  const { title, content }  = req.body;\n\n  if(title == '' || content ==''){\n    next(err);\n    return;\n  }\n  const post = new PostModel();\n  post.title = title;\n  post.content = content;\n  post.authorId = res.locals.currentUser._id;\n  post.save(function(err, doc) {\n    if (err) {\n      next(err);\n    } else {\n      res.json({post: doc});\n        }\n  });\n});\n\n/* PATCH edit post */\nrouter.patch('/posts/:id', function(req,res,next){\n  const { id, title, content } = req.params;\n\n  PostModel.findOneAndUpdate({_id: id},{title,content}, function(err){\n    if(err){\n      next(err);\n    }else{\n      res.end();\n    }\n  });\n});\n\n/* GET one post */\nrouter.get('/posts/:id', function(req, res, next) {\n  const id = req.params.id;\n  // const {id} =req.params;\n\n  PostModel.findOne({ _id: id }, function(err, post) {\n    if (err) {\n      next(err);\n    } else {\n      res.json({  post });\n    }\n  });\n});\n\n/* DEL one post */\nrouter.delete('/posts/:id', function (req, res) {\n  const id = req.params.id;\n  PostModel.remove({_id: id}, function (err, data) {\n    if(err){\n      next(err);\n    }else{\n      res.json({});\n    }\n  });\n});\n\n\n/* POST signup user */\nrouter.post('/signup', function(req, res, next) {\n  const {name, pass, rePass} =req.body;\n\n  if (pass !== rePass) {\n    return next(new Error('两次密码不对'));\n  }\n\n  const user = new UserModel();\n  user.name = name;\n  user.pass = bcrypt.hashSync(pass, 10);\n  user.save(function(err) {\n    if (err) {\n      next(err);\n    } else {\n      res.end();\n    }\n  });\n});\n\n/* POST signin user */\nrouter.post('/signin', function(req, res, next) {\nconst {name, pass} = req.body;\n\n  UserModel.findOne({ name }, function(err, user) {\n    if (err || !user) {\n      return next(new Error('找不到用户'));\n    } else {\n      const isOk = bcrypt.compareSync(pass, user.pass);\n      if (!isOk) {\n        return next(new Error('密码不对'));\n      }\n\n      const token = jwt.encode(\n        {\n          _id: user._id,\n          name: user.name,\n          isAdmin: user.name === config.admin ? true : false,\n          exp: moment().add('days', 30).valueOf(),\n        },\n        config.jwtSecret\n      );\n\n      const opts = {\n        path: '/',\n        maxAge: 1000 * 60 * 60 * 24 * 30, // cookie 有效期30天\n        signed: true,\n        httpOnly: true\n      };\n\n      res.cookie(config.cookieName, token, opts);\n      res.json({ token });\n    }\n  });\n});\n\nexport default router;\n"]}
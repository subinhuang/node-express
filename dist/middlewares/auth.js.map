{"version":3,"sources":["../../src/middlewares/auth.js"],"names":["authUser","req","res","next","locals","currentUser","token","headers","signedCookies","cookieName","decoded","decode","jwtSecret","exp","Date","now","end","user","err","userRequired","Error","status","adminRequired","isAdmin"],"mappings":";;;;;;;AAAA;;;;AACA;;;;AACA;;;;;;AAEO,IAAMA,8BAAW,SAAXA,QAAW,CAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC1CD,MAAIE,MAAJ,CAAWC,WAAX,GAAyB,IAAzB;;AAEA,MAAMC,QACJL,IAAIM,OAAJ,CAAY,gBAAZ,KAAiCN,IAAIO,aAAJ,CAAkB,iBAAOC,UAAzB,CAAjC,IAAyE,EAD3E;;AAGA,MAAIH,KAAJ,EAAW;AACT,QAAI;AACF,UAAMI,UAAU,oBAAIC,MAAJ,CAAWL,KAAX,EAAkB,iBAAOM,SAAzB,CAAhB;AACA,UAAIF,QAAQG,GAAR,IAAeC,KAAKC,GAAL,EAAnB,EAA+B;AAC7Bb,YAAIc,GAAJ,CAAQ,0BAAR,EAAoC,GAApC;AACA;AACD;;AAEDf,UAAIgB,IAAJ,GAAWf,IAAIE,MAAJ,CAAWC,WAAX,GAAyBK,OAApC;AACA,aAAOP,MAAP;AACD,KATD,CASE,OAAOe,GAAP,EAAY;AACZ,aAAOf,MAAP;AACD;AACF,GAbD,MAaO;AACLA;AACD;AACF,CAtBM;;AAwBA,IAAMgB,sCAAe,SAAfA,YAAe,CAAClB,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC9C,MAAI,CAACF,IAAIgB,IAAT,EAAe;AACb,QAAIC,MAAM,IAAIE,KAAJ,CAAU,MAAV,CAAV;AACAF,QAAIG,MAAJ,GAAa,GAAb;AACAlB,SAAKe,GAAL;AACA;AACD;;AAEDf;AACD,CATM;;AAWA,IAAMmB,wCAAgB,SAAhBA,aAAgB,CAACrB,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC/C,MAAI,CAACF,IAAIgB,IAAT,EAAe;AACb,QAAIC,MAAM,IAAIE,KAAJ,CAAU,MAAV,CAAV;AACAF,QAAIG,MAAJ,GAAa,GAAb;AACAlB,SAAKe,GAAL;AACA;AACD;;AAED,MAAI,CAACjB,IAAIgB,IAAJ,CAASM,OAAd,EAAuB;AACrB,QAAIL,OAAM,IAAIE,KAAJ,CAAU,SAAV,CAAV;AACAF,SAAIG,MAAJ,GAAa,GAAb;AACAlB,SAAKe,IAAL;AACA;AACD;;AAEDf;AACD,CAhBM","file":"auth.js","sourcesContent":["import jwt from 'jwt-simple';\nimport config from '../config';\nimport UserModel from '../models/user';\n\nexport const authUser = (req, res, next) => {\n  res.locals.currentUser = null;\n\n  const token =\n    req.headers['x-access-token'] || req.signedCookies[config.cookieName] || '';\n\n  if (token) {\n    try {\n      const decoded = jwt.decode(token, config.jwtSecret);\n      if (decoded.exp <= Date.now()) {\n        res.end('Access token has expired', 400);\n        return;\n      }\n\n      req.user = res.locals.currentUser = decoded;\n      return next();\n    } catch (err) {\n      return next();\n    }\n  } else {\n    next();\n  }\n};\n\nexport const userRequired = (req, res, next) => {\n  if (!req.user) {\n    let err = new Error('需要登录');\n    err.status = 403;\n    next(err);\n    return;\n  }\n\n  next();\n};\n\nexport const adminRequired = (req, res, next) => {\n  if (!req.user) {\n    let err = new Error('需要登录');\n    err.status = 403;\n    next(err);\n    return;\n  }\n\n  if (!req.user.isAdmin) {\n    let err = new Error('需要管理员权限');\n    err.status = 403;\n    next(err);\n    return;\n  }\n\n  next();\n};\n"]}